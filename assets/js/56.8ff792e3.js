(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{544:function(e,t,a){"use strict";a.r(t);var s=a(30),n=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("blockquote",[a("p",[e._v("本文作者来自 "),a("a",{attrs:{href:"https://www.zhihu.com/org/hua-er-jie-jian-wen-ji-zhu-tuan-dui-92/activities",target:"_blank",rel:"noopener noreferrer"}},[e._v("华尔街见闻技术团队"),a("OutboundLink")],1),e._v(" - "),a("a",{attrs:{href:"https://github.com/PanJiaChen",target:"_blank",rel:"noopener noreferrer"}},[e._v("花裤衩"),a("OutboundLink")],1)])]),e._v(" "),a("p",[e._v("前几天 webpack 作者 "),a("a",{attrs:{href:"https://github.com/sokra",target:"_blank",rel:"noopener noreferrer"}},[e._v("Tobias Koppers"),a("OutboundLink")],1),e._v(" 发布了一篇新的文章 "),a("a",{attrs:{href:"https://medium.com/webpack/webpack-4-0-to-4-16-did-you-know-71e25a57fa6b",target:"_blank",rel:"noopener noreferrer"}},[e._v("webpack 4.0 to 4.16: Did you know?"),a("OutboundLink")],1),e._v("(需翻墙)，总结了一下"),a("code",[e._v("webpack 4")]),e._v("发布以来，做了哪些调整和优化。"),a("br"),e._v("\n并且说自己正在着手开发 "),a("code",[e._v("webpack 5")]),e._v("。")]),e._v(" "),a("blockquote",[a("p",[e._v("Oh you are still on webpack 3. I’m sorry, what is blocking you? We already working on webpack 5, so your stack might be outdated soon…")])]),e._v(" "),a("p",[e._v("翻译成中文就是：")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/7/27/164db1a2e089c151?w=690&h=200&f=jpeg&s=22433",alt:""}})]),e._v(" "),a("p",[e._v("正好我也在使用一个文档生成工具 "),a("a",{attrs:{href:"https://github.com/pedronauck/docz",target:"_blank",rel:"noopener noreferrer"}},[e._v("docz"),a("OutboundLink")],1),e._v("(安利一波) 也最低需要"),a("code",[e._v("webpack 4+")]),e._v("，新版"),a("code",[e._v("webpack")]),e._v("性能提高了不少，而且"),a("code",[e._v("webpack 4")]),e._v(" 都已经发布五个多月了，想必应该已经没什么坑了，应该可以安心的按照别人写的升级攻略升级了。之前一直迟迟不升级完全是被去年被 "),a("code",[e._v("webpack 3")]),e._v(" 坑怕了。它在 "),a("code",[e._v("code splitting")]),e._v(" 的情况下 "),a("code",[e._v("CommonsChunkPlugin")]),e._v("会完全失效。过了好一段时间才修复，欲哭无泪。")]),e._v(" "),a("p",[e._v("所以这次我等了快大半年才准备升级到"),a("code",[e._v("webpack 4")]),e._v(" "),a("strong",[e._v("但万万没想到还是遇到了不少的问题！")]),e._v(" 有很多之前遗留的问题还是没有很好地解决。但最主要的问题还是它的文档有所欠缺，已经废除了的东西如"),a("code",[e._v("commonsChunkPlugin")]),e._v("还在官方文档中到处出现，很多重要的东西却一笔带过，甚至没写，需要用户自己去看源码才能解决。")]),e._v(" "),a("p",[e._v("还比如在"),a("code",[e._v("v4.16.0")]),e._v("版本中废除了"),a("code",[e._v("optimization.occurrenceOrder")]),e._v("、"),a("code",[e._v("optimization.namedChunks")]),e._v("、"),a("code",[e._v("optimization.hashedModuleIds")]),e._v("、"),a("code",[e._v("optimization.namedModules")]),e._v(" 这几个配置项，替换成了"),a("code",[e._v("optimization.moduleIds")]),e._v(" 和 "),a("code",[e._v("optimization.chunkIds")]),e._v("，但文档完中全没有任何体现，所以你在新版本中还按照文档那样配置其实是没有任何效果的。")]),e._v(" "),a("p",[e._v("最新最完整的文档还是看他项目的配置"),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/master/schemas/WebpackOptions.json",target:"_blank",rel:"noopener noreferrer"}},[e._v("WebpackOptions.json"),a("OutboundLink")],1),e._v("，强烈建议遇到不清楚的配置项可以看这个，因为它一定保证是和最新代码同步的。")]),e._v(" "),a("p",[e._v("吐槽了这么多，我们言归正传。由于本次手摸手篇幅有些长，所以拆解成了上下两篇文章：")]),e._v(" "),a("ul",[a("li",[e._v("上篇 -- 就是普通的在"),a("code",[e._v("webpack 3")]),e._v("的基础上升级，要做哪些操作和遇到了哪些坑")]),e._v(" "),a("li",[e._v("下篇 -- 是在"),a("code",[e._v("webpack 4")]),e._v("下怎么合理的打包和拆包，并且如何最大化利用 "),a("code",[e._v("long term caching")])])]),e._v(" "),a("p",[a("strong",[e._v("本文章不是手摸手从零教你 webpack 配置，所以并不会讲太多很基础的配置问题")]),e._v("。比如如何处理 css 文件，如何配置 webpack-dev-server，讲述 file-loader 和 url-loader 之间的区别等等，有需求的推荐看 "),a("a",{attrs:{href:"https://webpack.js.org/concepts/",target:"_blank",rel:"noopener noreferrer"}},[e._v("官方文档"),a("OutboundLink")],1),e._v(" 或者 "),a("a",{attrs:{href:"https://survivejs.com/webpack/developing/webpack-dev-server/",target:"_blank",rel:"noopener noreferrer"}},[e._v("survivejs"),a("OutboundLink")],1),e._v(" 出的一个系列教程。或者推荐看我司的另一篇 wbepack 入门文章，已同步到 webpack4 "),a("a",{attrs:{href:"https://github.com/wallstreetcn/webpack-and-spa-guide",target:"_blank",rel:"noopener noreferrer"}},[e._v("传送门"),a("OutboundLink")],1),e._v("。")]),e._v(" "),a("h2",{attrs:{id:"升级篇"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级篇"}},[e._v("#")]),e._v(" 升级篇")]),e._v(" "),a("h3",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[e._v("#")]),e._v(" 前言")]),e._v(" "),a("p",[e._v("我一直认为模仿和借鉴是学习一个新东西最高效的方法。所以我建议还是通过借鉴一些成熟的 webpack 配置比较好。比如你项目是基于 react 生态圈的话可以借鉴 "),a("a",{attrs:{href:"https://github.com/facebook/create-react-app",target:"_blank",rel:"noopener noreferrer"}},[e._v("create-react-app"),a("OutboundLink")],1),e._v(" ，下载之后"),a("code",[e._v("npm run eject")]),e._v(" 就可以看到它详细的 webpack 配置了。vue 的话由于新版"),a("code",[e._v("vue cli")]),e._v("不支持 "),a("code",[e._v("eject")]),e._v("了，而且改用 "),a("a",{attrs:{href:"https://github.com/mozilla-neutrino/webpack-chain",target:"_blank",rel:"noopener noreferrer"}},[e._v("webpack-chain"),a("OutboundLink")],1),e._v("来配置，所以借鉴起来可能会不太方便，主要配置 "),a("a",{attrs:{href:"https://github.com/vuejs/vue-cli/tree/dev/packages/@vue/cli-service/lib/config",target:"_blank",rel:"noopener noreferrer"}},[e._v("地址"),a("OutboundLink")],1),e._v("。觉得麻烦的话你可以直接借鉴 "),a("code",[e._v("vue-element-admin")]),e._v(" 的 "),a("a",{attrs:{href:"https://github.com/PanJiaChen/vue-element-admin/pull/889",target:"_blank",rel:"noopener noreferrer"}},[e._v("配置"),a("OutboundLink")],1),e._v("。或者你想自己发挥，你可以借鉴 webpack 官方的各种 "),a("a",{attrs:{href:"https://github.com/webpack/webpack/tree/master/examples",target:"_blank",rel:"noopener noreferrer"}},[e._v("examples"),a("OutboundLink")],1),e._v("，来组合你的配置。")]),e._v(" "),a("h3",{attrs:{id:"升级-webpack"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级-webpack"}},[e._v("#")]),e._v(" 升级 webpack")]),e._v(" "),a("p",[e._v("首先将 webpack 升级到 4 之后，直接运行"),a("code",[e._v("webpack --xxx")]),e._v("是不行的，因为新版本将命令行相关的东西单独拆了出去封装成了"),a("code",[e._v("webpack-cli")]),e._v("。会报如下错误：")]),e._v(" "),a("blockquote",[a("p",[e._v("The CLI moved into a separate package: webpack-cli."),a("br"),e._v("\nPlease install "),a("code",[e._v("webpack-cli")]),e._v(" in addition to webpack itself to use the CLI.")])]),e._v(" "),a("p",[e._v("所有你需要安装"),a("code",[e._v("npm install webpack-cli -D -S")]),e._v("。你也可将它安装在全局。")]),e._v(" "),a("p",[e._v("同时新版 webpack 需要"),a("code",[e._v("Node.js 的最低支持版本为 6.11.5")]),e._v("不要忘了升级。如果还需要维护老项目可以使用 "),a("a",{attrs:{href:"https://github.com/creationix/nvm",target:"_blank",rel:"noopener noreferrer"}},[e._v("nvm"),a("OutboundLink")],1),e._v(" 来做一下 node 版本管理。")]),e._v(" "),a("p",[a("strong",[e._v("升级所有依赖")])]),e._v(" "),a("p",[e._v("因为"),a("code",[e._v("webpack4")]),e._v("改了 它的"),a("code",[e._v("hook")]),e._v(" api ，所以所有的"),a("code",[e._v("loaders")]),e._v("、"),a("code",[e._v("plugins")]),e._v("都需要升级才能够适配。")]),e._v(" "),a("p",[e._v("可以使用命令行 "),a("code",[e._v("npm outdated")]),e._v("，列出所以可以更新的包。免得再一个个去"),a("code",[e._v("npm")]),e._v("找相对于的可用版本了。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/7/27/164da832e18a97ef?w=890&h=346&f=jpeg&s=105563",alt:""}})]),e._v(" "),a("p",[e._v("反正把"),a("code",[e._v("devDependencies")]),e._v("的依赖都升级一下，总归不会有错。")]),e._v(" "),a("h3",{attrs:{id:"带来的变化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#带来的变化"}},[e._v("#")]),e._v(" 带来的变化")]),e._v(" "),a("p",[e._v("其实这次升级带来了不少改变，但大部分其实对于普通用户来说是不需要关注的，比如这次升级带来的功能"),a("code",[e._v("SideEffects")]),e._v("、"),a("code",[e._v("Module Type’s Introduced")]),e._v("、"),a("code",[e._v("WebAssembly Support")]),e._v("，基本平时是用不到的。我们主要关注那些对我们影响比较大的改动如："),a("code",[e._v("optimization.splitChunks")]),e._v("代替原有的"),a("code",[e._v("CommonsChunkPlugin")]),e._v("(下篇文章会着重介绍)，和"),a("code",[e._v("Better Defaults-mode")]),e._v("更好的默认配置，这是大家稍微需要关注一下的。")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[e._v("废弃项")]),e._v(" "),a("th",{staticStyle:{"text-align":"left"}},[e._v("替代项(optimization)")]),e._v(" "),a("th",{staticStyle:{"text-align":"center"}},[e._v("主要功能")])])]),e._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[e._v("UglifyjsWebpackPlugin")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v(".minmize")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("压缩优化")])]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[e._v("ModuleConcatenationPlugin")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v(".opconcatenateModules")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("Scope hoisting")])]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[e._v("CommonsChunkPlugin")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v(".splitChunks/.runtimeChunk")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("Code splitting")])]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[e._v("NoEmitOnErrorsPlugin")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v("noEmitOnErrors")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("编译出现错误，跳过输出阶段")])])])]),e._v(" "),a("blockquote",[a("p",[e._v("如果想进一步了解 "),a("code",[e._v("Tree Shaking")]),e._v("和"),a("code",[e._v("SideEffects")]),e._v("的可见文末拓展阅读。"),a("br"),e._v(" "),a("em",[e._v("上图参考 "),a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/35407642",target:"_blank",rel:"noopener noreferrer"}},[e._v("Webpack 4 进阶"),a("OutboundLink")],1)])])]),e._v(" "),a("h3",{attrs:{id:"默认配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#默认配置"}},[e._v("#")]),e._v(" 默认配置")]),e._v(" "),a("p",[e._v("webpack 4 引入了"),a("code",[e._v("零配置")]),e._v("的概念，被 "),a("a",{attrs:{href:"https://github.com/parcel-bundler/parcel",target:"_blank",rel:"noopener noreferrer"}},[e._v("parcel"),a("OutboundLink")],1),e._v(" 刺激到了。 不管效果怎样，这改变还是值得称赞的。")]),e._v(" "),a("blockquote",[a("p",[e._v("最近又新出了 "),a("a",{attrs:{href:"http://fastpack.io/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Fastpack"),a("OutboundLink")],1),e._v(" 可以关注一下。")])]),e._v(" "),a("p",[e._v("言归正题，我们来看看 webpack 默认帮我们做了些什么?")]),e._v(" "),a("p",[a("code",[e._v("development")]),e._v(" 模式下，默认开启了"),a("code",[e._v("NamedChunksPlugin")]),e._v(" 和"),a("code",[e._v("NamedModulesPlugin")]),e._v("方便调试，提供了更完整的错误信息，更快的重新编译的速度。")]),e._v(" "),a("div",{staticClass:"language-diff line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-diff"}},[a("code",[e._v("module.exports = {\n"),a("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[a("span",{pre:!0,attrs:{class:"token prefix inserted"}},[e._v("+")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v(" mode: 'development'\n")])]),a("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[a("span",{pre:!0,attrs:{class:"token prefix deleted"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v(" devtool: 'eval',\n")]),a("span",{pre:!0,attrs:{class:"token prefix deleted"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v(" plugins: [\n")]),a("span",{pre:!0,attrs:{class:"token prefix deleted"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v("   new webpack.NamedModulesPlugin(),\n")]),a("span",{pre:!0,attrs:{class:"token prefix deleted"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v("   new webpack.NamedChunksPlugin(),\n")]),a("span",{pre:!0,attrs:{class:"token prefix deleted"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v('   new webpack.DefinePlugin({ "process.env.NODE_ENV": JSON.stringify("development") }),\n')]),a("span",{pre:!0,attrs:{class:"token prefix deleted"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v(" ]\n")])]),e._v("}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br")])]),a("p",[a("code",[e._v("production")]),e._v(" 模式下，由于提供了"),a("code",[e._v("splitChunks")]),e._v("和"),a("code",[e._v("minimize")]),e._v("，所以基本零配置，代码就会自动分割、压缩、优化，同时 webpack 也会自动帮你 "),a("code",[e._v("Scope hoisting")]),e._v(" 和 "),a("code",[e._v("Tree-shaking")]),e._v("。")]),e._v(" "),a("div",{staticClass:"language-diff line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-diff"}},[a("code",[e._v("module.exports = {\n"),a("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[a("span",{pre:!0,attrs:{class:"token prefix inserted"}},[e._v("+")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v("  mode: 'production',\n")])]),a("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[a("span",{pre:!0,attrs:{class:"token prefix deleted"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v("  plugins: [\n")]),a("span",{pre:!0,attrs:{class:"token prefix deleted"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v("    new UglifyJsPlugin(/* ... */),\n")]),a("span",{pre:!0,attrs:{class:"token prefix deleted"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v('    new webpack.DefinePlugin({ "process.env.NODE_ENV": JSON.stringify("production") }),\n')]),a("span",{pre:!0,attrs:{class:"token prefix deleted"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v("    new webpack.optimize.ModuleConcatenationPlugin(),\n")]),a("span",{pre:!0,attrs:{class:"token prefix deleted"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v("    new webpack.NoEmitOnErrorsPlugin()\n")]),a("span",{pre:!0,attrs:{class:"token prefix deleted"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token line"}},[e._v("  ]\n")])]),e._v("}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br")])]),a("p",[e._v("webpack 一直以来最饱受诟病的就是其配置门槛极高，配置内容极其复杂和繁琐，容易让人从入门到放弃，而它的后起之秀如 rollup、parcel 等均在配置流程上做了极大的优化，做到开箱即用，所以"),a("code",[e._v("webpack 4")]),e._v(" 也从中借鉴了不少经验来提升自身的配置效率。"),a("strong",[e._v("愿世间再也不需要 webpack 配置工程师")]),e._v("。")]),e._v(" "),a("h2",{attrs:{id:"html-webpack-plugin"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#html-webpack-plugin"}},[e._v("#")]),e._v(" html-webpack-plugin")]),e._v(" "),a("p",[e._v("用最新版本的的 "),a("code",[e._v("html-webpack-plugin")]),e._v("你可能还会遇到如下的错误：")]),e._v(" "),a("p",[a("code",[e._v("throw new Error('Cyclic dependency' + nodeRep)")])]),e._v(" "),a("p",[e._v("产生这个 bug 的原因是循环引用依赖，如果你没有这个问题可以忽略。")]),e._v(" "),a("p",[e._v("目前解决方案可以使用 Alpha 版本，"),a("code",[e._v("npm i --save-dev html-webpack-plugin@next")])]),e._v(" "),a("p",[e._v("或者加入"),a("code",[e._v("chunksSortMode: 'none'")]),e._v("就可以了。")]),e._v(" "),a("p",[e._v("但仔细查看文档发现设置成"),a("code",[e._v("chunksSortMode: 'none'")]),e._v("这样是会有问题的。")]),e._v(" "),a("blockquote",[a("p",[e._v("Allows to control how chunks should be sorted before they are included to the HTML.")])]),e._v(" "),a("p",[e._v("这属性会决定你 chunks 的加载顺序，如果设置为"),a("code",[e._v("none")]),e._v("，你的 chunk 加载在页面中加载的顺序就不能够保证了，可能会出现样式被覆盖的情况。比如我在"),a("code",[e._v("app.css")]),e._v("里面修改了一个第三方库"),a("code",[e._v("element-ui")]),e._v("的样式，通过加载顺序的先后来覆盖它，但由于设置为了"),a("code",[e._v("none")]),e._v("，打包出来的结果变成了这样：")]),e._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),e._v("link")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("href")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')]),e._v("/app.8945fbfc.css"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')])]),e._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("rel")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')]),e._v("stylesheet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')])]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("/>")])]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),e._v("link")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("href")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')]),e._v("/chunk-elementUI.2db88087.css"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')])]),e._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("rel")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')]),e._v("stylesheet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')])]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("/>")])]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[a("code",[e._v("app.css")]),e._v("被先加载了，之前写的样式覆盖就失效了，除非你使用"),a("code",[e._v("important")]),e._v("或者其它 css 权重的方式覆盖它，但这明显是不太合理的。"),a("br"),e._v(" "),a("code",[e._v("vue-cli")]),e._v("正好也有这个相关 "),a("a",{attrs:{href:"https://github.com/vuejs/vue-cli/issues/1978#issuecomment-409267484",target:"_blank",rel:"noopener noreferrer"}},[e._v("issue"),a("OutboundLink")],1),e._v("，尤雨溪也在不使用"),a("code",[e._v("@next")]),e._v("版本的基础上 hack 了它，有兴趣的可以自己研究一下，本人在项目中直接使用了"),a("code",[e._v("@next")]),e._v("版本，也没遇到其它什么问题（除了不兼容 webpack 的 "),a("code",[e._v("prefetch/preload")]),e._v(" 相关 "),a("a",{attrs:{href:"https://github.com/jantimon/html-webpack-plugin/issues/934",target:"_blank",rel:"noopener noreferrer"}},[e._v("issue"),a("OutboundLink")],1),e._v("）。两种方案都可以，自行选择。")]),e._v(" "),a("p",[e._v("其它 "),a("code",[e._v("html-webpack-plugin")]),e._v(" 的配置和之前使用没有什么区别。")]),e._v(" "),a("h2",{attrs:{id:"mini-css-extract-plugin"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mini-css-extract-plugin"}},[e._v("#")]),e._v(" mini-css-extract-plugin")]),e._v(" "),a("h3",{attrs:{id:"与-extract-text-webpack-plugin-区别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#与-extract-text-webpack-plugin-区别"}},[e._v("#")]),e._v(" 与 extract-text-webpack-plugin 区别")]),e._v(" "),a("p",[e._v("由于"),a("code",[e._v("webpack4")]),e._v("对 css 模块支持的完善以及在处理 css 文件提取的方式上也做了些调整，所以之前我们一直使用的"),a("code",[e._v("extract-text-webpack-plugin")]),e._v("也完成了它的历史使命，将让位于"),a("code",[e._v("mini-css-extract-plugin")]),e._v("。")]),e._v(" "),a("p",[e._v("使用方式也很简单，大家看着 "),a("a",{attrs:{href:"https://github.com/webpack-contrib/mini-css-extract-plugin#minimal-example",target:"_blank",rel:"noopener noreferrer"}},[e._v("文档"),a("OutboundLink")],1),e._v(" 抄就可以了。")]),e._v(" "),a("p",[e._v("它与"),a("code",[e._v("extract-text-webpack-plugin")]),e._v("最大的区别是：它在"),a("code",[e._v("code spliting")]),e._v("的时候会将原先内联写在每一个 js "),a("code",[e._v("chunk bundle")]),e._v("的 css，单独拆成了一个个 css 文件。")]),e._v(" "),a("p",[e._v("原先 css 是这样内联在 js 文件里的："),a("br"),e._v(" "),a("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/7/24/164cb85b234d224a?w=2534&h=98&f=jpeg&s=50714",alt:""}})]),e._v(" "),a("p",[e._v("将 css 独立拆包最大的好处就是 js 和 css 的改动，不会影响对方。比如我改了 js 文件并不会导致 css 文件的缓存失效。而且现在它自动会配合"),a("code",[e._v("optimization.splitChunks")]),e._v("的配置，可以自定义拆分 css 文件，比如我单独配置了"),a("code",[e._v("element-ui")]),e._v("作为单独一个"),a("code",[e._v("bundle")]),e._v(",它会自动也将它的样式单独打包成一个 css 文件，不会像以前默认将第三方的 css 全部打包成一个几十甚至上百 KB 的"),a("code",[e._v("app.xxx.css")]),e._v("文件了。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/7/24/164cbd49dc148656?w=516&h=254&f=png&s=73856",alt:""}})]),e._v(" "),a("h3",{attrs:{id:"压缩与优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#压缩与优化"}},[e._v("#")]),e._v(" 压缩与优化")]),e._v(" "),a("p",[e._v("打包 css 之后查看源码，我们发现它并没有帮我们做代码压缩，这时候需要使用 "),a("a",{attrs:{href:"https://github.com/NMFR/optimize-css-assets-webpack-plugin",target:"_blank",rel:"noopener noreferrer"}},[e._v("optimize-css-assets-webpack-plugin"),a("OutboundLink")],1),e._v(" 这个插件，它不仅能帮你压缩 css 还能优化你的代码。")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//配置")]),e._v("\noptimization"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  minimizer"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("OptimizeCSSAssetsPlugin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/7/30/164e93dc299d7062?w=1778&h=764&f=jpeg&s=198182",alt:""}})]),e._v(" "),a("p",[e._v("如上图测试用例所示，由于"),a("code",[e._v("optimize-css-assets-webpack-plugin")]),e._v("这个插件默认使用了 "),a("a",{attrs:{href:"https://github.com/cssnano/cssnano",target:"_blank",rel:"noopener noreferrer"}},[e._v("cssnano"),a("OutboundLink")],1),e._v(" 来作 css 优化，"),a("br"),e._v("\n所以它不仅压缩了代码、删掉了代码中无用的注释、还去除了冗余的 css、优化了 css 的书写顺序，优化了你的代码 "),a("code",[e._v("margin: 10px 20px 10px 20px;")]),e._v(" =>"),a("code",[e._v("margin:10px 20px;")]),e._v("。同时大大减小了你 css 的文件大小。更多优化的细节见"),a("a",{attrs:{href:"https://cssnano.co/guides/optimisations",target:"_blank",rel:"noopener noreferrer"}},[e._v("文档"),a("OutboundLink")],1),e._v("。")]),e._v(" "),a("h3",{attrs:{id:"contenthash"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#contenthash"}},[e._v("#")]),e._v(" contenthash")]),e._v(" "),a("p",[e._v("但使用 "),a("code",[e._v("MiniCssExtractPlugin")]),e._v(" 有一个需求特别注意的地方，在默认文档中它是这样配置的：")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("MiniCssExtractPlugin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Options similar to the same options in webpackOptions.output")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// both options are optional")]),e._v("\n  filename"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" devMode "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("?")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'[name].css'")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'[name].[hash].css'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  chunkFilename"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" devMode "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("?")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'[id].css'")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'[id].[hash].css'")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br")])]),a("blockquote",[a("p",[e._v("简单说明一下： "),a("code",[e._v("filename")]),e._v(" 是指在你入口文件"),a("code",[e._v("entry")]),e._v("中引入生成出来的文件名，而"),a("code",[e._v("chunkname")]),e._v("是指那些未被在入口文件"),a("code",[e._v("entry")]),e._v("引入，但又通过按需加载（异步）模块的时候引入的文件。")])]),e._v(" "),a("p",[e._v("在 "),a("strong",[e._v("copy")]),e._v(" 如上代码使用之后发现情况不对！每次改动一个"),a("code",[e._v("xx.js")]),e._v("文件，它对应的 css 虽然没做任何改动，但它的 文件 hash 还是会发生变化。仔细对比发现原来是 "),a("code",[e._v("hash")]),e._v(" 惹的祸。 "),a("code",[e._v("6.f3bfa3af.css")]),e._v(" => "),a("code",[e._v("6.40bc56f6.css")])]),e._v(" "),a("p",[a("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/7/24/164cbe27801ebf69?w=1214&h=308&f=png&s=162463",alt:""}})]),e._v(" "),a("p",[e._v("但我这是根据官方文档来写的！为什么还有问题！后来在文档的"),a("strong",[e._v("最最最")]),e._v("下面发下了这么一段话！")]),e._v(" "),a("blockquote",[a("p",[e._v("For long term caching use filename: "),a("code",[e._v("[contenthash].css")]),e._v(". Optionally add [name].")])]),e._v(" "),a("p",[e._v("非常的不理解，这么关键的一句话会放在 "),a("code",[e._v("Maintainers")]),e._v(" 还后面的地方，默认写在配置里面提示大家不是更好？有热心群众已经开了一个"),a("code",[e._v("pr")]),e._v("，将文档默认配置为 "),a("code",[e._v("contenthash")]),e._v("。"),a("code",[e._v("chunkhash")]),e._v(" => "),a("code",[e._v("contenthash")]),e._v("相关 "),a("a",{attrs:{href:"https://github.com/webpack/webpack.js.org/issues/2096",target:"_blank",rel:"noopener noreferrer"}},[e._v("issue"),a("OutboundLink")],1),e._v("。")]),e._v(" "),a("p",[e._v("这个真的蛮过分的，稍不注意就会让自己的 css 文件缓存无效。而且很多用户平时修改代码的时候都不会在意自己最终打包出来的 "),a("code",[e._v("dist")]),e._v("文件夹中到底有哪些变化。所以这个问题可能就一直存在了。浪费了多少资源！人艰不拆！大家觉得 webpack 难用不是没道理的。")]),e._v(" "),a("h3",{attrs:{id:"这里再简单说明一下几种-hash-的区别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#这里再简单说明一下几种-hash-的区别"}},[e._v("#")]),e._v(" 这里再简单说明一下几种 hash 的区别：")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("hash")])])]),e._v(" "),a("p",[a("code",[e._v("hash")]),e._v(" 和每次 "),a("code",[e._v("build")]),e._v("有关，没有任何改变的情况下，每次编译出来的 "),a("code",[e._v("hash")]),e._v("都是一样的，但当你改变了任何一点东西，它的"),a("code",[e._v("hash")]),e._v("就会发生改变。")]),e._v(" "),a("p",[e._v("简单理解，你改了任何东西，"),a("code",[e._v("hash")]),e._v(" 就会和上次不一样了。")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("chunkhash")])])]),e._v(" "),a("p",[a("code",[e._v("chunkhash")]),e._v("是根据具体每一个模块文件自己的的内容包括它的依赖计算所得的"),a("code",[e._v("hash")]),e._v("，所以某个文件的改动只会影响它本身的"),a("code",[e._v("hash")]),e._v("，不会影响其它文件。")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("contenthash")])])]),e._v(" "),a("p",[e._v("它的出现主要是为了解决，让"),a("code",[e._v("css")]),e._v("文件不受"),a("code",[e._v("js")]),e._v("文件的影响。比如"),a("code",[e._v("foo.css")]),e._v("被"),a("code",[e._v("foo.js")]),e._v("引用了，所以它们共用相同的"),a("code",[e._v("chunkhash")]),e._v("值。但这样子是有问题的，如果"),a("code",[e._v("foo.js")]),e._v("修改了代码，"),a("code",[e._v("css")]),e._v("文件就算内容没有任何改变，由于是该模块的 "),a("code",[e._v("hash")]),e._v(" 发生了改变，其"),a("code",[e._v("css")]),e._v("文件的"),a("code",[e._v("hash")]),e._v("也会随之改变。")]),e._v(" "),a("p",[e._v("这个时候我们就可以使用"),a("code",[e._v("contenthash")]),e._v("了，保证即使"),a("code",[e._v("css")]),e._v("文件所处的模块里有任何内容的改变，只要 css 文件内容不变，那么它的"),a("code",[e._v("hash")]),e._v("就不会发生变化。")]),e._v(" "),a("p",[a("code",[e._v("contenthash")]),e._v(" 你可以简单理解为是 "),a("code",[e._v("moduleId")]),e._v(" + "),a("code",[e._v("content")]),e._v(" 所生成的 "),a("code",[e._v("hash")]),e._v("。")]),e._v(" "),a("h2",{attrs:{id:"热更新速度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#热更新速度"}},[e._v("#")]),e._v(" 热更新速度")]),e._v(" "),a("p",[e._v("其实相对 webpack 线上打包速度，我更关心的本地开发热更新速度，毕竟这才是和我们每一个程序员每天真正打交道的东西，打包一般都会扔给"),a("code",[e._v("CI")]),e._v("自动执行，而且一般项目每天也不会打包很多次。")]),e._v(" "),a("p",[a("code",[e._v("webpack 4")]),e._v("一直说自己更好的利用了"),a("code",[e._v("cache")]),e._v("提高了编译速度，但实测发现是有一定的提升，但当你一个项目，路由懒加载的页面多了之后，50+之后，热更新慢的问题会很明显，之前的"),a("a",{attrs:{href:"https://juejin.im/post/595b4d776fb9a06bbe7dba56#heading-1",target:"_blank",rel:"noopener noreferrer"}},[e._v("文章"),a("OutboundLink")],1),e._v("中也提到过这个问题，原以为新版本会解决这个问题，但并没有。")]),e._v(" "),a("p",[e._v("不过你首先要排斥你的热更新慢不是，如：")]),e._v(" "),a("ul",[a("li",[e._v("没有使用合理的 "),a("a",{attrs:{href:"https://webpack.js.org/configuration/devtool/#devtool",target:"_blank",rel:"noopener noreferrer"}},[e._v("Devtool"),a("OutboundLink")],1),e._v(" souce map 导致")]),e._v(" "),a("li",[e._v("没有正确使用 "),a("a",{attrs:{href:"https://webpack.js.org/configuration/module/#rule-include",target:"_blank",rel:"noopener noreferrer"}},[e._v("exclude/include"),a("OutboundLink")],1),e._v(" 处理了不需要处理的如"),a("code",[e._v("node_modules")])]),e._v(" "),a("li",[e._v("在开发环境不要压缩代码"),a("code",[e._v("UglifyJs")]),e._v("、提取 css、babel polyfill、计算文件 hash 等不需要的操作")])]),e._v(" "),a("p",[a("strong",[e._v("旧方案")])]),e._v(" "),a("p",[e._v("最早的方案是开发环境中不是用路由懒加载了，只在线上环境中使用。封装一个"),a("code",[e._v("_import")]),e._v("函数，通过环境变区分是否需要懒加载。")]),e._v(" "),a("p",[e._v("开发环境：")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[e._v("exports")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("file")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'@/views/'")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("+")]),e._v(" file "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("+")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'.vue'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("default\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("生成环境：")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[e._v("exports")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("file")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'@/views/'")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("+")]),e._v(" file "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("+")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'.vue'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("但由于 webpack "),a("code",[e._v("import")]),e._v("实现机制问题，会产生一定的副作用。如上面的写法就会导致"),a("code",[e._v("@/views/")]),e._v("下的 所有"),a("code",[e._v(".vue")]),e._v(" 文件都会被打包。不管你是否被依赖引用了，会多打包一些可能永远都用不到 js 代码。 "),a("a",{attrs:{href:"https://github.com/PanJiaChen/vue-element-admin/issues/292",target:"_blank",rel:"noopener noreferrer"}},[e._v("相关 issue"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("目前新的解决方案思路还是一样的，只在生成模式中使用路由懒加载，本地开发不使用懒加载。但换了一种没副作用的实现方式。")]),e._v(" "),a("p",[a("strong",[e._v("新方案")])]),e._v(" "),a("p",[e._v("使用"),a("code",[e._v("babel")]),e._v(" 的 "),a("code",[e._v("plugins")]),e._v(" "),a("a",{attrs:{href:"https://github.com/airbnb/babel-plugin-dynamic-import-node",target:"_blank",rel:"noopener noreferrer"}},[e._v("babel-plugin-dynamic-import-node"),a("OutboundLink")],1),e._v("。它只做一件事就是：将所有的"),a("code",[e._v("import()")]),e._v("转化为"),a("code",[e._v("require()")]),e._v("，这样就可以用这个插件将所有异步组件都用同步的方式引入了，并结合 "),a("a",{attrs:{href:"https://babeljs.io/docs/usage/babelrc/#env-option",target:"_blank",rel:"noopener noreferrer"}},[e._v("BABEL_ENV"),a("OutboundLink")],1),e._v(" 这个"),a("code",[e._v("bebel")]),e._v("环境变量，让它只作用于开发环境下。将开发环境中所有"),a("code",[e._v("import()")]),e._v("转化为"),a("code",[e._v("require()")]),e._v("，这种方案解决了之前重复打包的问题，同时对代码的侵入性也很小，你平时写路由的时候只需要按照官方"),a("a",{attrs:{href:"https://router.vuejs.org/zh/guide/advanced/lazy-loading.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("文档"),a("OutboundLink")],1),e._v("路由懒加载的方式就可以了，其它的都交给"),a("code",[e._v("babel")]),e._v("来处理，当你不想用这个方案的时候，也只需要将它从"),a("code",[e._v("babel")]),e._v(" 的 "),a("code",[e._v("plugins")]),e._v("中移除就可以了。")]),e._v(" "),a("p",[a("strong",[e._v("具体代码：")])]),e._v(" "),a("p",[e._v("首先在"),a("code",[e._v("package.json")]),e._v("中增加"),a("code",[e._v("BABEL_ENV")])]),e._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"dev"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"BABEL_ENV=development webpack-dev-server XXXX"')]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("接着在"),a("code",[e._v(".babelrc")]),e._v("只能加入"),a("code",[e._v("babel-plugin-dynamic-import-node")]),e._v("这个"),a("code",[e._v("plugins")]),e._v("，并让它只有在"),a("code",[e._v("development")]),e._v("模式中才生效。")]),e._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"env"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"development"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"plugins"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"dynamic-import-node"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br")])]),a("p",[e._v("之后就大功告成了，路由只要像平时一样写就可以了。"),a("a",{attrs:{href:"https://panjiachen.github.io/vue-element-admin-site/zh/guide/advanced/lazy-loading.html#%E6%96%B0%E6%96%B9%E6%A1%88",target:"_blank",rel:"noopener noreferrer"}},[e._v("文档"),a("OutboundLink")],1)]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" path"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'/login'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[e._v("component")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'@/views/login/index'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("这样能大大提升你热更新的速度。基本两百加页面也能在"),a("code",[e._v("2000ms")]),e._v("的热跟新完成，基本做到无感刷新。当然你的项目本身就不大页面也不多，完全没必要搞这些。"),a("strong",[e._v("当你的页面变化跟不是你写代码速度的时候再考虑也不迟。")])]),e._v(" "),a("h2",{attrs:{id:"打包速度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#打包速度"}},[e._v("#")]),e._v(" 打包速度")]),e._v(" "),a("p",[a("code",[e._v("webpack 4")]),e._v(" 在项目中实际测了下，普遍能提高 20%~30%的打包速度。")]),e._v(" "),a("p",[e._v("本文不准备太深入的讲解这部分内容，详细的打包优化速度可以参考"),a("a",{attrs:{href:"https://slack.engineering/keep-webpack-fast-a-field-guide-for-better-build-performance-f56a5995e8f1",target:"_blank",rel:"noopener noreferrer"}},[e._v(" slack 团队的这篇文章"),a("OutboundLink")],1),e._v("，掘金还有"),a("a",{attrs:{href:"https://github.com/xitu/gold-miner/blob/master/TODO/keep-webpack-fast-a-field-guide-for-better-build-performance.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("译文"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("p",[e._v("这里有几个建议来帮你加速 webpack 的打包速度。")]),e._v(" "),a("p",[e._v("首先你需要知道你目前打包慢，是慢在哪里。")]),e._v(" "),a("p",[e._v("我们可以用 "),a("a",{attrs:{href:"https://github.com/stephencookdev/speed-measure-webpack-plugin#readme",target:"_blank",rel:"noopener noreferrer"}},[e._v("speed-measure-webpack-plugin"),a("OutboundLink")],1),e._v(" 这个插件，它能监控 webpack 每一步操作的耗时。如下图：")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/7/31/164eee200ebc1911?w=554&h=492&f=jpeg&s=92342",alt:""}})]),e._v(" "),a("p",[e._v("可以看出其实大部分打包花费的时间是在"),a("code",[e._v("Uglifyjs")]),e._v("压缩代码。和前面的提升热更新的切入点差不多，查看"),a("code",[e._v("source map")]),e._v("的正确与否，"),a("code",[e._v("exclude/include")]),e._v("的正确使用等等。")]),e._v(" "),a("p",[e._v("使用新版的"),a("code",[e._v("UglifyJsPlugin")]),e._v("的时候记住可以加上"),a("code",[e._v("cache: true")]),e._v("、"),a("code",[e._v("parall: true")]),e._v("，可以提搞代码打包压缩速度。更多配置可以参考 "),a("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin",target:"_blank",rel:"noopener noreferrer"}},[e._v("文档"),a("OutboundLink")],1),e._v(" 或者 vue-cli 的 "),a("a",{attrs:{href:"https://github.com/vuejs/vue-cli/blob/dev/packages/@vue/cli-service/lib/config/uglifyOptions.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("配置"),a("OutboundLink")],1),e._v("。")]),e._v(" "),a("p",[e._v("编译的时候还有还有一个很慢的原因是那些第三方库。比如"),a("code",[e._v("echarts")]),e._v("、"),a("code",[e._v("element-ui")]),e._v("其实都非常的大，比如"),a("code",[e._v("echarts")]),e._v("打包完也还有 775kb。所以你想大大提高编译速度，可以将这些第三方库 "),a("code",[e._v("externals")]),e._v(" 出去，使用"),a("code",[e._v("script")]),e._v("的方式引入，或者使用 "),a("code",[e._v("dll")]),e._v("的方式打包。经测试一般如"),a("code",[e._v("echarts")]),e._v("这样大的包可以节省十几秒到几十秒不等。")]),e._v(" "),a("p",[e._v("还有可以使用一些并行执行 webpack 的库：如"),a("a",{attrs:{href:"https://github.com/trivago/parallel-webpack",target:"_blank",rel:"noopener noreferrer"}},[e._v("parallel-webpack"),a("OutboundLink")],1),e._v("、"),a("a",{attrs:{href:"https://github.com/amireh/happypack",target:"_blank",rel:"noopener noreferrer"}},[e._v("happypack"),a("OutboundLink")],1),e._v("。")]),e._v(" "),a("p",[a("strong",[e._v("顺便说一下，升级一下"),a("code",[e._v("node")]),e._v("可能有惊喜。前不久将"),a("code",[e._v("CI")]),e._v("里面的 node 版本依赖从 "),a("code",[e._v("6.9.2")]),e._v(" => "),a("code",[e._v("8.11.3")]),e._v("，打包速度直接提升了一分多钟。")])]),e._v(" "),a("p",[e._v("总之我觉得打包时间控制在差不多的范围内就可以了，没必要过分的优化。可能你研究了半天，改了一堆参数发现其实也就提升了几秒，但维护成本上去了，得不偿失。还不如升级 node、升级 webpack、升级你的编译环境的硬件水平来的实在和简单。")]),e._v(" "),a("p",[e._v("比如我司"),a("code",[e._v("CI")]),e._v("使用的是腾讯云普通的的 8 核 16g 的机器，这个项目也是一个很大的后台管理项目 200+页面，引用了很多第三方的库，但没有使用什么"),a("code",[e._v("happypack")]),e._v("、"),a("code",[e._v("dll")]),e._v("，只是用了最新版的"),a("code",[e._v("webpack4")]),e._v("，"),a("code",[e._v("node@8.11.3")]),e._v("。"),a("br"),e._v("\n编译速度稳定在两分多钟，完全不觉得有什么要优化的必要。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/7/29/164e5366dd1d9dec?w=896&h=236&f=jpeg&s=22563",alt:""}})]),e._v(" "),a("h2",{attrs:{id:"tree-shaking"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tree-shaking"}},[e._v("#")]),e._v(" Tree-Shaking")]),e._v(" "),a("p",[e._v("这其实并不是 webpack 4 才提出来的概念，最早是 "),a("a",{attrs:{href:"https://github.com/rollup/rollup",target:"_blank",rel:"noopener noreferrer"}},[e._v("rollup"),a("OutboundLink")],1),e._v(" 提出来并实现的，后来在 webpack 2 中就实现了，本次在 webpack 4 只是增加了 "),a("code",[e._v("JSON Tree Shaking")]),e._v("和"),a("code",[e._v("sideEffects")]),e._v("能让你能更好的"),a("strong",[e._v("摇")]),e._v("。")]),e._v(" "),a("p",[e._v("不过这里还是要提一下，默认 webpack 是支持"),a("code",[e._v("Tree-Shaking")]),e._v("的，但在你的项目中可能会因为"),a("code",[e._v("babel")]),e._v("的原因导致它失效。")]),e._v(" "),a("p",[e._v("因为"),a("code",[e._v("Tree Shaking")]),e._v("这个功能是基于"),a("code",[e._v("ES6 modules")]),e._v(" 的静态特性检测，来找出未使用的代码，所以如果你使用了 babel 插件的时候，如："),a("a",{attrs:{href:"https://babeljs.io/docs/en/babel-preset-env/",target:"_blank",rel:"noopener noreferrer"}},[e._v("babel-preset-env"),a("OutboundLink")],1),e._v("，它默认会将模块打包成"),a("code",[e._v("commonjs")]),e._v("，这样就会让"),a("code",[e._v("Tree Shaking")]),e._v("失效了。")]),e._v(" "),a("p",[e._v("其实在 webpack 2 之后它自己就支持模块化处理。所以只要让 babel 不"),a("code",[e._v("transform modules")]),e._v("就可以了。配置如下：")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// .babelrc")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"presets"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"env"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n      modules"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("...")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br")])]),a("p",[e._v("顺便说一下都 8102 年了，请不要在使用"),a("code",[e._v("babel-preset-esxxxx")]),e._v("系列了，请用"),a("code",[e._v("babel-preset-env")]),e._v("，相关文章 "),a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/29506685",target:"_blank",rel:"noopener noreferrer"}},[e._v("再见，babel-preset-2015"),a("OutboundLink")],1),e._v("。")]),e._v(" "),a("p",[e._v("拓展阅读：")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://juejin.im/post/5b5d6d6f6fb9a04fea58aabc",target:"_blank",rel:"noopener noreferrer"}},[e._v("手摸手，带你用合理的姿势使用 webpack4 （下）"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/wallstreetcn/webpack-and-spa-guide",target:"_blank",rel:"noopener noreferrer"}},[e._v("Webpack 4 和单页应用入门"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/40052192",target:"_blank",rel:"noopener noreferrer"}},[e._v("Webpack 中的 sideEffects 到底该怎么用？"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/32831172",target:"_blank",rel:"noopener noreferrer"}},[e._v("你的 Tree-Shaking 并没什么卵用"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/32148338",target:"_blank",rel:"noopener noreferrer"}},[e._v("对 webpack 文档的吐槽"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/32554436",target:"_blank",rel:"noopener noreferrer"}},[e._v("Tree-Shaking 性能优化实践 - 原理篇"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/29506685",target:"_blank",rel:"noopener noreferrer"}},[e._v("再见，babel-preset-2015"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=n.exports}}]);